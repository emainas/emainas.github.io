---
title: 'Sunday Recap - Cool things I learned this week'
date: 2025-03-23
permalink: /posts/2025/03/23/sunday-recap/
tags:
  - research recap
  - things I learned
  - scheduler tricks
  - end-state free energy calculations
  - denoising diffusion models
---

# Scheduler tricks

Recently I starting working with QM/MM Umbrella Sampling calculations. I use [Amber](https://ambermd.org) for the Molecular Mechanics part and [Terachem](http://www.petachem.com/products.html) for the electronic structure calculations. The communication between the two softwares is not a trivial issue but has been solved sufficiently with the terachem-protocol-buffer ([TCPB](https://pubmed.ncbi.nlm.nih.gov/36725506/)). However, the amount of files produced and memory used is massive. 20 umbrella windows alone produced ~15,000,000 files and 2.6Tb of memory which means that I started recieving the notorious "exceeded memory limits" emails from the IT department. Naturally, the question rises: How do I rigorously monitor the jobs running, their memory usage and the number of files generated?

To understand how much memory these files occupied and also to measure their number, I wrote this trivial bash scirpt (also added timing because the du -sh command is pretty slow):

```bash 
#!/bin/bash

MeasureMemory() {
        read -p "Enter index1:" index1
        read -p "Enter index2:" index2
        read -p "Enter step:" step

        total=0
        for (( i = index1; i <= index2; i+= step )); do
                start=$(date +%s)
                output=$(du -sh "d_${i}_0_")
                echo "$output"
                num=$(echo "$output" | awk '{ if (match($0, /[0-9]+/)) print substr($0, RSTART, RLENGTH) }')
                total=$((total + num))
                end=$(date +%s)
                elapsed=$(echo "$end - $start" | bc)
                echo "Iteration ${i} took ${elapsed} seconds to finish!"
        done
        echo "Total memory is: ${total}G"
}

NumberOfFiles() {
        read -p "Enter index1:" index1
        read -p "Enter index2:" index2
        read -p "Enter step:" step
        total=0
        for (( i = index1; i <= index2; i+= step )); do
                count=$(find "d_${i}_0_" -type f | wc -l)
                total=$((total + count))
                echo "Directory d_${i}_0 contains ${count} files."
        done
        echo "Total number of files is: ${total}"
}


MeasureMemory
NumberOfFiles
```

Very cool things I learned writing these script were:
1. Bash performs brace expansion before any variable substitution so you need to use C-style loops when you have variables.
2. The command [date](https://man7.org/linux/man-pages/man1/date.1.html) +%s outputs the current time as a Unix timestamp, which is the number of seconds that have elapsed since January 1, 1970 (known as the Unix epoch).
3. You can use awkâ€™s regular expression matching to extract the integer part from a string. Other (easier) ways exist.
4. Not in the script but I used this very cool Linux command [sort](https://man7.org/linux/man-pages/man1/sort.1.html).

# End-state free energy methods

# Denoising diffusion models

---
